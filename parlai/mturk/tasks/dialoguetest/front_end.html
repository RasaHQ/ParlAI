<div id="intro">
  In this task you will take one of two roles:
  You could be a 'user' who wants to find a new apartment in Sydney or, alternatively, you
  could take the role of a 'virtual assistant' that helps the user achieve this goal.
</div>
<div id="intro_user" style="display: none">
  You recently started a <b>new job in Sydney</b> and need to find an apartment to live in.
  For now, you stay in a hotel, but that is expensive, so you'll <b>want to find something soon</b>.
  A friend of yours recommended the virtual assistant that you are about to talk to now.
  Maybe it can help you find something you like?
  <br><br>
</div>
<div id="todo_user" style="display: none">
  Your task is complete, when
  <ul>
    <li>You found an apartment that satisfies at least <b>4 specific criteria</b> of your choosing (e.g. number of rooms, balcony/elevator availability, etc.) - you might have to make some compromises to find something</li>
    <li>You have <b>changed your mind about what you want at least once</b> during the conversation</li>
    <li>You said <b>goodbye</b> (or similar) at the end of your dialogue</li>
  </ul>
  At the end of this dialogue, you will have to judge if the assistant fulfilled his/her task.<br>
</div>
<div id="intro_wizard" style="display: none">
  You play the role of a <b>virtual assistant</b> that helps people find an apartment in Sydney.
  The user that you talk to may sometimes change his/her mind and may not be sure what he/she wants.
  Your task is to be as helpful to the user as possible in any case, but <b>you cannot do anything but searching and discussing apartments</b>.
  So if the user wants you to make coffee, you should explain that you cannot do this.
  If you feel like you should provide the user with an example apartment, <b>just make up a description</b>.

  Users may even be rude or uncooperative, but you are beyond this and <b>always keep a patient, level tone</b>.
  <br><br>
</div>
<div id="todo_wizard" style="display: none">
  Your task is complete, when
  <ul>
    <li>The user has found a suitable apartment</li>
    <li>The user has said 'goodbye' (or similar)</li>
  </ul>
  At the end of this dialogue, you will have to judge if the user fulfilled his/her task.<br>
</div>
<div id="ask_accept">
If you are ready, please click "Accept HIT" to start this task.<br>
</div>

<div id="input"></div>
<div float="right">
  <button class="btn btn-primary" style="width: 120px; font-size: 16px; float: left; margin-left: 10px; padding: 0px;" id="done_button">Confirm</button>
  <button class="btn btn-primary" style="width: 220px; font-size: 16px; float: left; margin-left: 10px; padding: 0px;" id="complete_button">I have completed my task</button>
</div>

<script type="text/javascript">

var num_messages = 0;
var numberOfItemTypes;

$("button#done_button").hide();
$("button#complete_button").hide();

function enable_button(button, enable) {
    if (enable) {
      button.removeClass('disabled');
      button.prop("disabled", false);
    } else {
      button.addClass("disabled");
      button.prop("disabled", true);
    }
}

function process_parlai_command(command, agent_id) {

  console.log(command);
  console.log(agent_id);

  $('#intro').html("");
  $('#ask_accept').html("");
  var div_intro_user = document.getElementById("intro_user");
  var div_intro_wizard = document.getElementById("intro_wizard");
  var div_todo_user = document.getElementById("todo_user");
  var div_todo_wizard = document.getElementById("todo_wizard");

  if (command == "setup") {
    console.log("JJJ: setup for " + agent_id);
    if (agent_id == "Wizard") {
      div_intro_user.style.display = "none";
      div_todo_user.style.display = "none";
      div_intro_wizard.style.display = "block";
      div_todo_wizard.style.display = "block";
    } else if (agent_id == "User") {
      div_intro_user.style.display = "block";
      div_todo_user.style.display = "block";
      div_intro_wizard.style.display = "none";
      div_todo_wizard.style.display = "none";
    }
    $("button#complete_button").show();
    <!--      document.getElementById("complete_button").disabled = true;-->
    enable_button($("button#complete_button"), false);
  } else if (command == "review") {
    console.log("JJJ: command is review");
    if (agent_id.startsWith("Wizard")) {
      console.log("JJJ: agent is wizard");
      review_form = "Thank you for the conversation. <br>";
      review_form += "Did the user...<br>";
      review_form += "<input type=\"checkbox\" id=\"ch_user_found\" name=\"ch_user_found\" value=\"ok_user_found\"><label for=\"ch_user_found\"> ... find an apartment?</label><br>";
      review_form += "<input type=\"checkbox\" id=\"ch_user_demands\" name=\"ch_user_demands\" value=\"ok_user_demands\"><label for=\"ch_user_demands\"> ... require at least 4 specific criteria?</label><br>";
      review_form += "<input type=\"checkbox\" id=\"ch_user_change\" name=\"ch_user_change\" value=\"ok_user_change\"><label for=\"ch_user_change\"> ... change his/her mind about what he/she wants at any point?</label><br>";
      review_form += "If you are unsure, then don't place a check mark.";

      div_intro_wizard.style.display = "block";
      div_intro_wizard.innerHTML = review_form;
      div_intro_user.style.display = "none";
      div_todo_user.style.display = "none";
      $("button#done_button").show();
      $("button#complete_button").hide();
    } else {
      console.log("JJJ: agent is user");
      review_form = "Thank you for the conversation. <br>";
      review_form += "Did the assistant... <br>";
      review_form += "<input type=\"checkbox\" id=\"ch_wizard_found\" name=\"ch_wizard_found\" value=\"ok_wizard_found\"><label for=\"ch_wizard_found\"> ... find an apartment for you?</label><br>";
      review_form += "<input type=\"checkbox\" id=\"ch_wizard_bye\" name=\"ch_wizard_bye\" value=\"ok_wizard_bye\"><label for=\"ch_wizard_bye\"> ... say goodbye at the end of the dialogue?</label><br>";
      review_form += "<input type=\"checkbox\" id=\"ch_wizard_polite\" name=\"ch_wizard_polite\" value=\"ok_wizard_polite\"><label for=\"ch_wizard_polite\"> ... stay polite and patient throughout the conversation?</label><br>";
      review_form += "If you are unsure, then don't place a check mark.";

      div_intro_user.style.display = "block";
      div_intro_user.innerHTML = review_form;
      div_intro_wizard.style.display = "none";
      div_todo_wizard.style.display = "none";
      $("button#done_button").show();
      $("button#complete_button").hide();
    }
    div_todo_user.style.display = "none";
    div_todo_wizard.style.display = "none";
  }
}

(function() {
    // Override handle_new_message function
    handle_new_message = function() {
        var new_message_id = arguments[0];
        var message = arguments[1];
        var agent_id = message.id;
        var text = message.text;
        var info = message.info;
        var was_this_agent = (agent_id == cur_agent_id);

        if (displayed_messages.indexOf(new_message_id) !== -1) {
            // This message has already been seen and put up into the chat
            log(new_message_id + ' was a repeat message', 1);
            return;
        }

        log('New message, ' + new_message_id + ' from agent ' + agent_id, 1);
        displayed_messages.push(new_message_id);

        if (message.command) {
            process_parlai_command(message.command, agent_id);
        } else if (text.startsWith('<query>')) {
            message.id = (was_this_agent ? "YOU" : agent_id);
            // add_message_to_conversation(was_this_agent ? "YOU" : "THEM", text, was_this_agent);
            add_message_to_conversation(was_this_agent ? "YOU" : agent_id, text, was_this_agent);
        } else {
            num_messages++;
            if (num_messages >= 8) {
                enable_button($("button#complete_button"), !was_this_agent);
            }

            message.id = (was_this_agent ? "YOU" : agent_id);
            add_message_to_conversation(was_this_agent ? "YOU" : agent_id, text, was_this_agent);
        }
    };
})();


function send_query(selection) {
      console.log("JJJ: Sending a query: " + selection);
      new_message_id = uuidv4();
      send_packet(
        TYPE_MESSAGE,
        {
          text: selection,
          id: cur_agent_id,
          message_id: new_message_id,
          episode_done: false
        },
        true,
        true,
        function(msg) {
        }
      );
}


$("button#done_button").on('click', function () {
  console.log("JJJ: agent clicked on DONE");
  var result = "{";

  if ($('#ch_user_demands').length > 0) {
    result += "'ch_user_demands': ";
    if (ch_user_demands.checked == true) {
      result += "True,";
    } else {
      result += "False,";
    }
    result += "'ch_user_found': ";
    if (ch_user_found.checked == true) {
      result += "True,";
    } else {
      result += "False,";
    }
    result += "'ch_user_change': ";
    if (ch_user_change.checked == true) {
      result += "True,";
    } else {
      result += "False,";
    }
  } else {
    result += "'ch_wizard_found': ";
    if (ch_wizard_found.checked == true) {
      result += "True,";
    } else {
      result += "False,";
    }
    result += "'ch_wizard_bye': ";
    if (ch_wizard_bye.checked == true) {
      result += "True,";
    } else {
      result += "False,";
    }
    result += "'ch_wizard_polite': ";
    if (ch_wizard_polite.checked == true) {
      result += "True,";
    } else {
      result += "False,";
    }
  }
  result += "}";
  send_query('<done> ' + result);
});

$("button#complete_button").on('click', function () {
  send_query('<complete>');
});

</script>